---
- name: Deploy SDN Node Monitor container (SDN and non-SDN modes)
  hosts: all
  become: true

  vars:
    image: "ghcr.io/dasmlab/sdn-node-monitor:latest"
    container_name: "sdn-node-monitor"
    node_mode: "sdn"            # sdn | non-sdn
    metrics_port: 8989          # host port
    check_interval: "30s"
    restart_interval: "5m"      # non-sdn periodic restart
    bgpd_service: "edpm_ovn_bgp_agent.service" # non-sdn service name
    log_level: "info"
    test_mode: "off"
    test_flip_interval: ""
    buffer_window: "30s"
    pid_mode: "ns:/proc/1/ns/pid"
    gossip_enabled: false
    gossip_port: 9393
    gossip_peers: ""
    gossip_hello_interval: "2m"
    otel_enabled: false
    otel_exporter_endpoint: ""
    otel_service_name: "sdn-node-monitor"
    podman_socket_dir: "/run/podman"
    selinux_enforcing: true

  tasks:
    - name: Pull SDN node monitor image
      ansible.builtin.command: "podman pull {{ image }}"
      changed_when: false

    - name: Install systemd unit for SDN node monitor
      ansible.builtin.copy:
        dest: /etc/systemd/system/{{ container_name }}.service
        owner: root
        group: root
        mode: "0644"
        content: |
          [Unit]
          Description=SDN Node Monitor container
          After=network-online.target
          Wants=network-online.target

          [Service]
          Restart=always
          ExecStartPre=-/usr/bin/podman rm -f {{ container_name }}
          ExecStart=/usr/bin/podman run \
            --name {{ container_name }} \
            --hostname %H \
            --privileged \
            {% if selinux_enforcing %}
            --security-opt label=disable \
            {% endif %}
            -e NODE_NAME=%H \
            -e NODE_MODE={{ node_mode }} \
            -e LOG_LEVEL={{ log_level }} \
            -e CHECK_INTERVAL={{ check_interval }} \
            -e RESTART_INTERVAL={{ restart_interval }} \
            -e BGPD_SERVICE={{ bgpd_service }} \
            -e METRICS_PORT=8080 \
            -e GOSSIP_ENABLED={{ gossip_enabled }} \
            -e GOSSIP_PORT={{ gossip_port }} \
            -e GOSSIP_PEERS={{ gossip_peers }} \
            -e GOSSIP_HELLO_INTERVAL={{ gossip_hello_interval }} \
            -e OTEL_ENABLED={{ otel_enabled }} \
            -e OTEL_SERVICE_NAME={{ otel_service_name }} \
            -e OTEL_EXPORTER_OTLP_ENDPOINT={{ otel_exporter_endpoint }} \
            -e TEST_MODE={{ test_mode }} \
            -e TEST_FLIP_INTERVAL={{ test_flip_interval }} \
            -e BUFFER_WINDOW={{ buffer_window }} \
            -e XDG_CONFIG_HOME=/app/.config \
            -e TINI_SUBREAPER=1 \
            {% if node_mode == 'non-sdn' %}
            --pid={{ pid_mode }} \
            -v /:/host:rw,rslave \
            -e HOST_ROOT=/host \
            {% endif %}
            {% if node_mode == 'sdn' %}
            -v {{ podman_socket_dir }}:{{ podman_socket_dir }}:rw{% if selinux_enforcing %},Z{% endif %} \
            {% endif %}
            -p {{ metrics_port }}:8080 \
            --network host \
            {{ image }}
          ExecStop=/usr/bin/podman stop -t 10 {{ container_name }}

          [Install]
          WantedBy=multi-user.target

    - name: Reload systemd and start SDN node monitor
      ansible.builtin.systemd:
        name: "{{ container_name }}.service"
        enabled: true
        state: started
        daemon_reload: true
