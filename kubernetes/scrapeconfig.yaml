# Prometheus ScrapeConfig for SDN Node Monitor
# This configures Prometheus to scrape metrics from the SDN node monitor containers
# running on each SDN node.
#
# Note: The container runs on port 8080 internally, but is mapped to host port 8989
# The scrape target should use the host IP and port 8989

apiVersion: v1
kind: ConfigMap
metadata:
  name: sdn-node-monitor-scrapeconfig
  namespace: monitoring  # Adjust namespace as needed
  labels:
    app: prometheus
data:
  scrapeconfig.yaml: |
    # SDN Node Monitor scrape configuration
    - job_name: 'sdn-node-monitor'
      scrape_interval: 30s
      scrape_timeout: 10s
      metrics_path: '/metrics'
      scheme: 'http'
      static_configs:
        - targets:
            # Add SDN node IPs here - use host port 8989 (container port 8080 is mapped to 8989)
            - '192.168.1.2:8989'
            # Add more nodes as needed:
            # - '192.168.1.3:8989'
            # - '192.168.1.4:8989'
          labels:
            job: 'sdn-node-monitor'
            component: 'sdn-monitoring'
            # Add hostname label per target (update with actual hostnames)
            # hostname: 'est2-m1-sdn01.idm.est.ngq.extra'
      relabel_configs:
        # Add instance label from target
        - source_labels: [__address__]
          regex: '([^:]+):\d+'
          target_label: instance
          replacement: '${1}'
        # Add node label (extract IP from target)
        - source_labels: [__address__]
          regex: '([^:]+):\d+'
          target_label: node
          replacement: '${1}'
        # Add hostname label - if hostname is set in static_configs labels, use it
        # Otherwise, you can resolve IP to hostname or set it manually per target
        - source_labels: [__meta_static_label_hostname]
          target_label: hostname
          # If hostname not in static labels, you can set it per target in static_configs
          # Or use this to copy from another label:
          # - source_labels: [instance]
          #   target_label: hostname
          #   replacement: '${1}'  # This would set hostname = IP (if you want that)

---
# Alternative: If using Prometheus Operator, use ScrapeConfig CRD instead
# Uncomment below and remove the ConfigMap above if using Prometheus Operator
#
# apiVersion: monitoring.coreos.com/v1
# kind: ScrapeConfig
# metadata:
#   name: sdn-node-monitor
#   namespace: monitoring
# spec:
#   jobName: sdn-node-monitor
#   scrapeInterval: 30s
#   scrapeTimeout: 10s
#   metricsPath: /metrics
#   scheme: http
#   staticConfigs:
#     - targets:
#         - '192.168.1.2:8989'
#       labels:
#         job: sdn-node-monitor
#         component: sdn-monitoring
#         # Add hostname label per target (update with actual hostnames)
#         # hostname: 'est2-m1-sdn01.idm.est.ngq.extra'
#   relabelConfigs:
#     - sourceLabels: [__address__]
#       regex: '([^:]+):\d+'
#       targetLabel: instance
#       replacement: '${1}'
#     - sourceLabels: [__address__]
#       regex: '([^:]+):\d+'
#       targetLabel: node
#       replacement: '${1}'
#     - sourceLabels: [__meta_static_label_hostname]
#       targetLabel: hostname
